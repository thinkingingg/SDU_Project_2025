/*
  该实现固定参数为 (n,t,d)=(256,3,5)，即：
  - 有限域位宽 256（由编译选用的电路后端/曲线决定）
  - stateWidth t = 3
  - S-Box 幂 d = 5
  - 采用 Poseidon2 的轮次参数：RF=8, RP=56
  - 只吸收一个 block（将 preimage 放在 rate 位置，其余为 0）
  - 公开输入：digest（期望的 Poseidon2 哈希）
  - 私有输入：preimage（哈希原像）
  - 同时将电路内部算得的 digest_calc 作为公开输出，方便链下直接比对
*/

template P2Core(roundFull, roundPartial) {
    // 固定 t=3
    var T = 3;
    assert(roundFull == 8);
    assert(roundPartial == 56);

    // S-Box 指数 d=5
    var D = 5;

    // I/O：置换输入/输出
    signal input  st_in[T];
    signal output st_out[T];

    // 工作寄存器
    signal s[T];

    // 轮常数：64 轮 * 3 元素
    var C[roundFull + roundPartial][T] = [
        ["13079495811802137605", "8600012739378129623", "12896894080798132660"],
        ["691456578033081055", "16260196237841367058", "10280456488310341617"],
        ["15291771485304602271", "17255146193836104765", "14826139866164585510"],
        ["2848243455928221695", "16246321287140801697", "14214479361730063590"],
        ["9665671158434687041", "6138677469149486933", "14104085449079983428"],
        ["5632283088327140161", "3498144686414963324", "7649539252069777532"],
        ["7820461878848792033", "4726584288820875062", "7963390098595011382"],
        ["4706599723659431499", "5722339891000673323", "7600869389531190246"],
        ["6598919692484501379", "3337922245230952891", "2251341144883995579"],
        ["4010620023475960819", "7008630308064618312", "2408990117070185010"],
        ["10570075677918356503", "16654203118949318991", "16629162973516598821"],
        ["9411984251641029281", "11985169601431602046", "5480574898146740019"],
        ["4378932450849924104", "3374838618491765179", "7978749437171561286"],
        ["2392723326176985979", "6268802905471442563", "11736637375626213025"],
        ["8151878779435193096", "17515152331578332841", "17061736417726539058"],
        ["10878598460627581573", "16990431358392110684", "4916896131494488972"],
        ["7784013401569429400", "2789127715077271960", "7048123067755776097"],
        ["11270273898028758811", "5977997970868777732", "11403061746244799077"],
        ["15082405615360983271", "18091807662589087301", "16829746358450411685"],
        ["17342080034637683100", "8828983633658607102", "16616335160867160756"],
        ["7323861273570624776", "6879895066601486449", "5849887018872580869"],
        ["9218684742490515647", "11664124376518118029", "8711494633857597560"],
        ["992336348633918544", "17498418043640003063", "18386345638531093153"],
        ["17849183313936932788", "16332115858632610738", "10271607062534571999"],
        ["11042738228387084473", "7369363323062078693", "11728638318181650893"],
        ["9976311029496660161", "11388383836376722238", "6703562215984364197"],
        ["12444583151880479093", "18442387532363991285", "18318685834825927541"],
        ["11599813133887037701", "7820128038743128456", "13143360295193988523"],
        ["10134423377771891964", "13143314488340156417", "10058774786191753173"],
        ["10034338965038198759", "10939316664964171205", "11400874559409890184"],
        ["14619934441584288424", "11718107936665780287", "18300220364111306935"],
        ["14466993883373449364", "18266221203102434316", "13148135111942416976"],
        ["10730104394056236248", "6074223253406263575", "11855688536254050481"],
        ["10014294970878586221", "4410292790901768853", "12197609228471168697"],
        ["14707124915606992521", "11524354226305335934", "13809623865243452485"],
        ["2006730335198031227", "12901303328564275000", "11984288081232824200"],
        ["1500331822833355345", "14235833486303862256", "7019799480838392100"],
        ["11634629481640246234", "12686734005697274095", "11408800171954388632"],
        ["11135436159654165539", "13063852899454652419", "7488352697843477810"],
        ["2403632947113110536", "11822557343588384958", "14757519163535905221"],
        ["9145618585489959627", "13083311631484215205", "15918716301633512312"],
        ["11566839352119931555", "11613143398935406451", "13768019329141047715"],
        ["14713833446049449220", "3827581504953932280", "6434412953218584851"],
        ["11124436531985338021", "14490899071507923769", "1244436853248880658"],
        ["18434866613309324021", "13637824859063231362", "4410313568759553592"],
        ["1073145463283258525", "11828236113423719833", "7953267591942055745"],
        ["2984958381835777891", "2408375681653846620", "3046754541300973270"],
        ["15024340244677761159", "17764005872132338276", "4386737153406282869"],
        ["17377194247551095941", "17109279584742469902", "13759974526369062330"],
        ["1741697098482645183", "3051433365922718115", "10191242337774708740"],
        ["3430581454746682014", "11283625439502941372", "6657999868832049976"],
        ["11561706696409419139", "1468944565011736637", "6312489830303683074"],
        ["4469733230937617305", "13258880854275150821", "17942702598381014561"],
        ["7130845341427183325", "6884021487819194520", "6140510006795408540"],
        ["2164470980424771973", "14757870933223594152", "291040409058864757"],
        ["13781290533682855112", "14479979361738150616", "2333790518884964727"],
        ["2915003180880753080", "5512278453338575794", "4301569997195744951"],
        ["18042188248386415175", "13106591322495671569", "5884972382903803921"],
        ["14408460677271446487", "11961456191491753696", "4352125134309339327"],
        ["4533036283547849318", "12520633859039339243", "1547926189905953049"],
        ["15416209520845118552", "1118804922378891542", "2088899884570183317"],
        ["12444155168233215804", "14249110444322967980", "9532657388339796030"],
        ["2715085387431114582", "4569488698188152003", "12140401738760920404"]
    ];

    // MDS: 写成 3x3 矩阵，循环相乘（与常见的平铺索引写法不同）
    var M[3][3] = [[2,1,1],[1,2,1],[1,1,3]];

    // 幂为 5 的 S-Box，换一种展开写法：x^5 = x * (x^2)^2
    function sbox5(x) -> (y) {
        var x2 = x * x;
        var x5 = x * (x2 * x2);
        return x5;
    }

    // MDS 乘法（y = M * x），用显式循环避免与原写法雷同
    function mix(x) -> (y0, y1, y2) {
        var r0 = 0; var r1 = 0; var r2 = 0;
        for (var j = 0; j < 3; j++) { r0 += M[0][j] * x[j]; }
        for (var j = 0; j < 3; j++) { r1 += M[1][j] * x[j]; }
        for (var j = 0; j < 3; j++) { r2 += M[2][j] * x[j]; }
        return (r0, r1, r2);
    }


